#!/usr/bin/env bash

set -eufo pipefail

# Only run if age key doesn't exist
if [ -f "{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt" ]; then
    exit 0
fi

# Create the directory
mkdir -p "{{ .chezmoi.homeDir }}/.config/chezmoi"

echo "Fetching age key attachment from ProtonPass..."

SHARE_ID="lyJLrLkUukBTAmlCxZkSjgakUVfyqPkDTsJMnO7qZHaYIgBUmsagWtCTCbDYDB7l51jn0AaBhT94Tes4zEVZCw=="
ITEM_ID="_vUbit8jDG8aK5mhEYVXw7-qdpLJGu_1VWqzy9SYB8NI7gkth66ZeBWOP5YQ7hZF7PT8XYraj3cjFC9G7yXqjg=="
ATTACHMENT_ID="5NBLQR7GvbCLLvwpBaThpxvulJFRQ6GV0k7z3s2rk8FSbQX6B343W9RUoKL2LVltYhdsXfscbqJdKqwV5OP0iQ=="

pass-cli item attachment download \
    --share-id="$SHARE_ID" \
    --item-id="$ITEM_ID" \
    --attachment-id="$ATTACHMENT_ID" \
    --output="{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt"

chmod 600 "{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt"

echo "âœ“ Age encryption key ready from ProtonPass"
