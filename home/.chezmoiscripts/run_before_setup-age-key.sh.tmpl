#!/usr/bin/env bash

set -eufo pipefail

# Only run if age key doesn't exist
if [ -f "{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt" ]; then
    exit 0
fi

# Get the attachment ID from Bitwarden
ATTACHMENT_ID=$(bw get item "Chezmoi Age Key" | jq -r '.attachments[0].id')
ITEM_ID=$(bw get item "Chezmoi Age Key" | jq -r '.id')

# Create the directory
mkdir -p "{{ .chezmoi.homeDir }}/.config/chezmoi"

# Download the attachment directly to the key file
bw get attachment "$ATTACHMENT_ID" --itemid "$ITEM_ID" --output "{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt"

chmod 600 "{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt"

echo "âœ“ Age encryption key restored from Bitwarden"
